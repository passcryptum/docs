# Password generation algorithm

Here you will learn the password generation algorithm used in the Passcryptum. The section describes the algorithm:

* In a deep level. Study the code fragments written in JavaScript as well, as the descriptions.
* In a simple level. Read the descriptions only.

For a deep understanding, we recommend you to paste the code fragments into the browser console and see the result. Change the benchmark data values to see that the algorithm will generate exactly the same password which will be generated by the Passcryptum.

```javascript
const originPassword = '123456'
const serviceName = 'github.com'
const login = 'nelkor'
const version = 1
const length = 20
const useSymbols = true
```

## Origin entropy

The application calculates the 128 bytes long data buffer by the cryptographic algorithm PBKDF2. This algorithm has adjustable difficulty, so you can choose the quantity of the data shuffle iterations.

For the origin entropy, the quantity of iterations is 262 144. It will make brute-forcing person’s origin password complicated. We can’t increase this number without limits, as the users with weak devices will face some delay while logging in the system.

```javascript
const originBuffer = new TextEncoder().encode(originPassword).buffer

Promise.all([
  crypto.subtle.importKey('raw', originBuffer, 'PBKDF2', false, ['deriveBits']),
  crypto.subtle.digest('SHA-256', originBuffer),
])
  .then(([key, salt]) =>
    crypto.subtle.deriveBits(
      {
        name: 'PBKDF2',
        hash: 'SHA-512',
        salt,
        iterations: 262144,
      },
      key,
      1024
    )
  )
  .then(result => {
    window.keyBufferFromOriginPassword = result
  })
```

This buffer can be applied for different tasks. As we are only interested in the part that directly participates in the password generation process.

```javascript
const entropyBuffer = keyBufferFromOriginPassword.slice(8, 80)
```

## Generation parameters

Other parameters, except for the origin password, which influence the password generation, need to be:

* United in one string.
* Separated by a comma.
* In a certain order.

```javascript
// For example: 'nelkor,20,1,true,github.com'
const paramsString = [login, length, version, useSymbols, serviceName].join()
```

## Merging buffers

Merge the origin entropy with the string parameters buffer.

```javascript
const paramsBuffer = new TextEncoder().encode(paramsString).buffer
const unitedBytesLength = entropyBuffer.byteLength + paramsBuffer.byteLength
const unitedBytes = new Uint8Array(unitedBytesLength)

unitedBytes.set(new Uint8Array(entropyBuffer), 0)
unitedBytes.set(new Uint8Array(paramsBuffer), entropyBuffer.byteLength)

const mergedBuffer = unitedBytes.buffer
```

## Password entropy

Shuffle the data from the merged buffer with the PBKDF2 algorithm. The quantity of iterations is only 16. The key length is 64 bytes.

```javascript
Promise.all([
  crypto.subtle.importKey('raw', mergedBuffer, 'PBKDF2', false, ['deriveBits']),
  crypto.subtle.digest('SHA-256', mergedBuffer),
])
  .then(([key, salt]) =>
    crypto.subtle.deriveBits(
      {
        name: 'PBKDF2',
        hash: 'SHA-512',
        salt,
        iterations: 16,
      },
      key,
      512
    )
  )
  .then(result => {
    window.passwordEntropyBuffer = result
  })
```

## Seeds

One seed is a number from 0 to 65 535. Use as many of them, as many characters in the password you want to have. Get them from the password entropy—2 bytes each seed. Others are insignificant.

```javascript
const seeds = Array.from(new Uint16Array(passwordEntropyBuffer, 0, length))
```

## Charset

The Passcryptum guaranties there will be at least one:

* A figure.
* A lowercase letter.
* A capital letter of the Latin alphabet.
* If the option <b>Use special symbols</b> is selected, a special character will be added.

To use guaranteed representatives from separate characters groups:

* A figure.
* A lowercase letter.
* A capital letter.
* A special character.

Other characters in the password must be perfectly random. Tale them from the unified set.

To achieve that,use the charset consisted of the three parts:

```javascript
const charset = [
'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
'abcdefghijklmnopqrstuvwxyz',
'0123456789',
]
```

To use special characters, additionally include the following part into the charset.

```javascript
if (useSymbols) {
  charset.push('`!@#$%^&*()-_=+{[]};:"|/.,<>')
}
```

```javascript
const charUnion = charset.join('')
```

## Stringification of entropy

Every symbol in the password stems from the rest of division of the seed by the size of the group of characters. A group of characters may be both a separate part of the set of characters and the whole unified charset. The rest of division is used as an index in order to take the character from the group.

First 3 or 4 seeds, depending on the usage of special characters, are transformed to the representatives of separate character groups. Other seeds are transformed into random characters from the unified set.

```javascript
const seedsLetters = seeds.map((seed, index) => {
  const letters = charset[index] || charUnion
  const char = letters.charAt(seed % letters.length)

return { char, seed }
})
```

As a result, we have received the characters which will be included into the password. The guaranteed representatives of the groups are on the first positions, which makes the password a little predictable. In order to get rid of this effect, sort the prepared characters in ascending order of the value of the seeds from which they have been received.

```javascript
seedsLetters
  .sort((a, b) => a.seed - b.seed)
  .map(({ char }) => char)
  .join('')
```

If you used the same benchmark data from the beginning of this article, you got the password: `%wBF.hkoq;kT%0UmuUy2`.

## Summary

The password generation is based on the mathematical operations.

Even if the application disappears for some reason, all the passwords are possible to restore manually. In a manual mode, it will take too long to generate passwords. The Passcryptum interface will complete all the necessary operations within a split second.